<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="admin.css">
    <title>Offerte</title>

    <style>
        .box-offerte {
            width: 50%;
            display: flex;
            flex-direction: column;
            margin: 15px auto;
            text-align: center;

            & table {
                width: 100%;
                border-collapse: unset;
            }

            & button {
                margin: 10px auto;
                width: 40%;
            }
        }

        .line {
            display: block;
            height: 2px;
            width: 90%;
            border-bottom: 1px solid black;
            margin: 10px auto 30px auto;
        }

        .box-offerte {
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            padding: 20px;
            text-align: center;

            & form {
                margin: 10px;
                display: flex;
                flex-direction: column;
            }

            & .form-box {
                display: inline-flex;
                justify-content: center;
            }

            & .row {
                position: relative;
                width: 50%;
                display: flex;
                flex-direction: column;
                margin-inline: 10px;
                margin-block: 5px;
                align-self: center;

                & .suggestion {
                    display: none;
                    position: absolute;
                    z-index: 2;
                    background-color: white;
                    box-shadow: 0 0 2px black;
                    border-radius: 0 0 10px 10px;
                    width: 100%;
                    top: 50px;
                    height: 100px;
                    overflow-y: scroll;
                }

                .suggestion > div {
                    padding: 5px 0;
                    cursor: pointer;
                }

                .suggestion > div:hover {
                    background-color: rgba(173, 173, 173, 0.3);
                }

            }

            & input {
                outline: none;
                border: none;
                box-shadow: 0 0 3px rgba(0, 0, 0, 0.34);
                height: 25px;
                width: 100%;
            }

            div.percentage > div {
                display: flex;
                flex-direction: row;
                justify-content: center;
                & input,
                & span {
                    width: 45%;
                    margin-inline: 5px;
                }

                & span {
                    border: 1px solid rgba(189, 189, 189, 0.37);
                }
            }

            input.wrong {
                color: red;
            }
        }
    </style>
</head>
<body>

<div id="main_container">
    <div id="content">
        <div id="prodotti" class="section">
            <h3>Offerte</h3>
            <hr>
            <div class="box-offerte">
                <form id="add_offerte" method="POST" action="#">
                    <div class="form-box">
                        <div class="row">
                            <label for="id_prod">ID Prodotto</label>
                            <input id="id_prod" type="text">
                            <div class="suggestion">
                                <!-- put here suggestions from json of all names. -->
                            </div>
                        </div>
                        <div class="row percentage">
                            <label for="percentage">Percentuale Sconto</label>
                            <div>
                                <input id="percentage" type="number" min="0" max="99">
                                <span id="output_percentage">price</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-box">
                        <div class="row">
                            <label for="startDate">Data Inizio</label>
                            <input id="startDate" type="date">
                        </div>
                        <div class="row">
                            <label for="endDate">Data Fine</label>
                            <input id="endDate" type="date">
                        </div>
                    </div>
                </form>
                <button form="add_offerte">
                    Aggiungi Offerta
                </button>
            </div>
            <span class="line"></span>
            <table>
                <tr>
                    <th>ID Offerta</th>
                    <th>ID Prodotto</th>
                    <th>Data Inizio</th>
                    <th>Data Fine</th>
                    <th>Percentuale</th>
                    <th></th>
                </tr>
                <tr>
                    <td>1</td>
                    <td>TR</td>
                    <td>Data Inizio</td>
                    <td>Data fine</td>
                    <td>Percentuale</td>
                    <td>
                        <button class="edit">
                            Rimuovi
                        </button>
                    </td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>TR</td>
                    <td>Data Inizio</td>
                    <td>Data fine</td>
                    <td>Percentuale</td>
                    <td>
                        <button class="edit">
                            Rimuovi
                        </button>
                    </td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>TR</td>
                    <td>Data Inizio</td>
                    <td>Data fine</td>
                    <td>Percentuale</td>
                    <td>
                        <button class="edit">
                            Rimuovi
                        </button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>
</body>
<script>
    let json = JSON.parse("[{\"id\":\"BR\",\"name\":\"Brachiosauro\",\"description\":\"Il Brachiosaurus è uno dei più grandi e imponenti dinosauri erbivori conosciuti. Caratterizzato da un corpo massiccio sostenuto da zampe anteriori più lunghe delle zampe posteriori, il Brachiosaurus si distingue per il suo lungo collo che gli consente di raggiungere i rami più alti degli alberi per nutrirsi.\",\"alimentazione\":\"erbivoro\",\"price\":25.5,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"CR\",\"name\":\"Ciro\",\"description\":\"Cir o Dinosaur\",\"alimentazione\":\"carnivoro\",\"price\":120000.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"GG\",\"name\":\"Guinzaglio gigante\",\"description\":\"Guinzaglio robusto per dinosauro gigante\",\"alimentazione\":null,\"price\":30.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"guinzaglio\",\"sconto\":0},{\"id\":\"GM\",\"name\":\"Guinzaglio medio\",\"description\":\"Guinzaglio in pelle per dinosauro di taglia media\",\"alimentazione\":null,\"price\":20.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"guinzaglio\",\"sconto\":0},{\"id\":\"MR\",\"name\":\"Microraptor\",\"description\":\"Il Microraptor è un piccolo dinosauro provvisto di quattro ali. Con i suoi circa 40 cm di lunghezza in età adulta ed un peso di circa 1 kg, il Microraptor rappresenta il più piccolo dinosauro carnivoro mai scoperto.\",\"alimentazione\":\"carnivoro\",\"price\":9.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"aria\",\"sconto\":0},{\"id\":\"OBR\",\"name\":\"Ossa di Brachiosauro\",\"description\":\"Ossa del più grande dinosauro erbivoro\",\"alimentazione\":null,\"price\":15.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OPT\",\"name\":\"Ossa di Pterodattilo\",\"description\":\"Ossa del grande rettile volante noto come Pterodattilo, con una vasta apertura alare\",\"alimentazione\":null,\"price\":8.5,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OST\",\"name\":\"Ossa di Stegosauro\",\"description\":\"Ossa di uno dei più iconici dinosauri erbivori, con le caratteristiche placche dorsali\",\"alimentazione\":null,\"price\":7.99,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OTC\",\"name\":\"Ossa di Triceratopo\",\"description\":\"Ossa del grande dinosauro erbivoro dotato di corna distintive\",\"alimentazione\":null,\"price\":6.99,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OTR\",\"name\":\"Ossa di T-rex\",\"description\":\"Ossa di uno dei più grandi e famosi dinosauri carnivori\",\"alimentazione\":null,\"price\":25.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OVL\",\"name\":\"Ossa di Velociraptor\",\"description\":\"Ossa di uno dei più noti e agili dinosauri carnivori, famoso per la sua velocità e intelligenza\",\"alimentazione\":null,\"price\":10.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"ossa\",\"sconto\":0},{\"id\":\"OVR\",\"name\":\"Oviraptor\",\"description\":\"L'Oviraptor è un piccolo dinosauro onnivoro noto per il suo becco adatto a rompere uova e ossa. Con il suo corpo leggero e le sue caratteristiche uniche, l'Oviraptor è uno degli esemplari più interessanti e studiati.\",\"alimentazione\":\"onnivoro\",\"price\":12.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"PL\",\"name\":\"Plesiosauro\",\"description\":\"Il Plesiosaurus è un grande dinosauro acquatico noto per il suo lungo collo e le grandi pinne che gli permettono di nuotare agilmente. Si nutre di pesci e altri piccoli animali marini, e il suo corpo affusolato è perfetto per la vita negli oceani.\",\"alimentazione\":\"carnivoro\",\"price\":22.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"acqua\",\"sconto\":0},{\"id\":\"PT\",\"name\":\"Pterodattilo\",\"description\":\"Il Pterodattilo è un dinosauro volante appartenente al gruppo dei pterosauri. Si distingue per la sua grande apertura alare, che può superare i sei metri. Si ritiene che sia principalmente un pescatore, ma può cacciare anche piccoli animali terrestri. Con il suo corpo leggero e le sue ali membranose, il Pterodattilo domina i cieli, rappresentando una delle più grandi creature volanti conosciute.\",\"alimentazione\":\"carnivoro\",\"price\":17.5,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"aria\",\"sconto\":0},{\"id\":\"ST\",\"name\":\"Stegosauro\",\"description\":\"Lo Stegosauro è un dinosauro erbivoro caratterizzato da una serie di placche ossee lungo il dorso e una lunga coda dotata di punte o spuntoni. Questa creatura preistorica vagabonda per le terre, nutrendosi di materiale vegetale grazie ai suoi piccoli denti piatti adatti a triturare.\",\"alimentazione\":\"erbivoro\",\"price\":18.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"TC\",\"name\":\"Triceratopo\",\"description\":\"Il Triceratopo è un grande dinosauro erbivoro caratterizzato da tre corna distintive sul cranio. Si distingue per il suo becco robusto e i denti adatti per strappare e triturare il cibo. Con il suo aspetto imponente e le sue difese naturali, il Triceratopo rappresenta una presenza dominante nel suo habitat. Si pensa che sia un animale pacifico, ma capace di difendersi dagli attacchi dei predatori con le sue corna e il suo grande corpo robusto.\",\"alimentazione\":\"erbivoro\",\"price\":17.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"TR\",\"name\":\"T-rex\",\"description\":\"Il Tyrannosaurus rex, comunemente noto come T-rex, è uno dei più grandi e famosi dinosauri carnivori. Caratterizzato da un cranio massiccio con denti lunghi e appuntiti, è un predatore formidabile. Con le sue poderose zampe posteriori, il T-rex è in grado di raggiungere velocità sorprendenti durante la caccia, rendendolo uno dei predatori dominanti.\",\"alimentazione\":\"carnivoro\",\"price\":21.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0},{\"id\":\"UBR\",\"name\":\"Uovo di Brachiosauro\",\"description\":\"Uovo di Brachiosauro parzialmente danneggiato\",\"alimentazione\":null,\"price\":15.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"UPT\",\"name\":\"Uovo di Pterodattilo\",\"description\":\"Uovo di Pterodattilo ben conservato\",\"alimentazione\":null,\"price\":8.5,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"UST\",\"name\":\"Uovo di Stegosauro\",\"description\":\"Uovo di Stegosauro ben conservato\",\"alimentazione\":null,\"price\":7.99,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"UTC\",\"name\":\"Uovo di Triceratopo\",\"description\":\"Uovo di Triceratopo leggermente aperto\",\"alimentazione\":null,\"price\":6.99,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"UTR\",\"name\":\"Uovo di T-rex\",\"description\":\"Uovo di T-rex trovato in buono stato\",\"alimentazione\":null,\"price\":10.5,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"UVL\",\"name\":\"Uovo di Velociraptor\",\"description\":\"Uovo di Velociraptor ben conservato\",\"alimentazione\":null,\"price\":10.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"uovo\",\"sconto\":0},{\"id\":\"VL\",\"name\":\"Velociraptor\",\"description\":\"Il Velociraptor è un dinosauro carnivoro noto per la sua agilità e intelligenza. Si ritiene che cacci in branco, nutrendosi principalmente di piccoli animali come altri dinosauri, rettili e insetti. Con le sue lunghe zampe posteriori e artigli affilati sulle zampe, il Velociraptor è un predatore formidabile, capace di raggiungere velocità sorprendenti durante la caccia.\",\"alimentazione\":\"carnivoro\",\"price\":15.0,\"quantity\":0,\"bought\":0,\"photo_path\":[],\"categoria\":\"terra\",\"sconto\":0}]");

    const startDate_input = document.getElementById("startDate");
    const endDate_input = document.getElementById("endDate");

    /* check input date even change state in startDate or endDate. */
    startDate_input.addEventListener("change", () => {
        compareDates();
    });

    endDate_input.addEventListener("change", () => {
        compareDates();
    });
    /*************************************************************/

    function compareDates() {
        const startDate = new Date(startDate_input.value);
        const endDate = new Date(endDate_input.value);

        if (startDate >= endDate) {
            endDate_input.classList.add("wrong");
        } else {
            /* the class can be added more than one time, then remove until is prensent. */
            while (endDate_input.classList.contains("wrong")) {
                endDate_input.classList.remove("wrong");
            }
        }
    }

    /************************* Add offer: Percentage box **************************/

    let input_field = document.getElementsByTagName("input");

    /* disable browser suggestion in the input field. (we use our stuff.)*/
    Array.from(input_field).forEach(el => {
        el.autocomplete = "off";
    });

    let output_percentage = document.getElementById("output_percentage");
    let percentage_input = document.getElementById("percentage");

    /* show price with setted percentage. */
    function show_set_price(id) {
        let price;
        let percentage_val = percentage_input.value;
        let id_find = id.toLocaleUpperCase();
        Array.from(json).every(el => {
            /* find in json the right id and retrieve price. */
            if (el.id.toLocaleUpperCase() === id_find) {
                price = parseFloat(el.price);
                return false;
            }

            return true;
        });

        if (percentage_val === 0 || percentage_val === null) {
            /* if percentage isn't set show default price. */
            output_percentage.innerHTML = price;
        } else if (percentage_val >= 0 && percentage_val <= 99) {
            /* if percentage is set show price with offer. */
            output_percentage.innerHTML = (price - ((price / 100) * percentage_val)).toFixed(2).toString();
        }
    }

    /* at press calculate price in the side span. */
    percentage_input.addEventListener("input", (event) => {
        let value = event.target.value;

        /* validate range in js after html. */
        if (value < 0 || value > 99) {
            console.log("Valore non cencesso");
        } else {
            show_set_price(input_name.value);
        }
    })

    /************************ Add offer: Suggestion box ID ************************/

    let suggestion_box = document.getElementsByClassName("suggestion")[0];
    let input_name = document.getElementById("id_prod");

    /* take all products from json, make upperCase and sort. */
    function generateSuggestionsArray() {
        let arr = [];
        for (let i = 0; i < json.length; ++i)
            arr.push(json[i].id + " - " + json[i].name.toUpperCase());

        arr.sort();
        return arr;
    }

    /* Hide with delay suggestion box. This help for event click. */
    input_name.addEventListener("focusout", () => {
        let hide_box = function() {
            suggestion_box.style.display = "none";
        }
        setTimeout(hide_box, 100);
    });

    /* Show suggestion box when focusin only if is already writtend at last one char and whe have some suggestion. */
    input_name.addEventListener("focusin", () => {
        if (input_name.value.length > 0 && suggestion_box.getElementsByTagName("div").length > 0)
            suggestion_box.style.display = "block";
    })

    let suggestions = generateSuggestionsArray();
    input_name.addEventListener("input", () => {
        let result;
        /* make input value as upperCase*/
        let val = document.getElementById("id_prod").value.toUpperCase();

        /* filter using prefix. */
        result = suggestions.filter(function(item){
            let arr = item.split(" - ");
            return arr[0].indexOf(val) === 0 || arr[1].indexOf(val) === 0;
        });

        /* update suggestions box. */
        suggestion_box.innerHTML = "";
        result.forEach(el => {
            /* create a single item and add to suggestion box. */
            let item = document.createElement("div");
            item.innerHTML = el;

            item.addEventListener("click", () => {
                input_name.value = item.innerHTML.split(" - ")[0];
                /* when we choose new ID let's show price. */
                show_set_price(input_name.value);
            });
            suggestion_box.append(item);
        })

        /* if we don't click in suggestion box, retrieve price when find the right match with ID. */
        suggestions.every((el) => {
            if (el.split(" - ")[0] === val) {
                show_set_price(input_name.value);
                return false;
            }

            return true;
        })

        /* show suggestions when written at last one character and have some suggestion. */
        if (input_name.value.length > 0 && suggestion_box.getElementsByTagName("div").length > 0)
            suggestion_box.style.display = "block";
        else
            suggestion_box.style.display = "none";
    })

</script>
</html>